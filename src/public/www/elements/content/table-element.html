<link rel='import' href='../behaviors/element-behavior.html'>
<dom-module id='table-element'>
  <template>
  <style>
    :host {
      /*height needs to be set by outer element*/
      color: var(--primary-text-color);
      display: flex;
      height: inherit;
      text-align: center;
      font-size: 0.75em;
      line-height: 1.5em;
      overflow: hidden;
      cursor: default;
      z-index: auto;
      background: white;
      border-radius: inherit;
      border-color: #BBBBBB;
    }
    :host[dark] {
      background: #a8a8a8;
      border-color: #808080;
    }
    section#table {
      display: flex;
      position: relative;
      flex-direction: column;
      border-color: inherit;
    }
    section#caption {
      display: block;
      position: relative;
      flex: 0;
      font-size: 0.9em;
      font-weight: bold;
      padding: 0em 1.5em;
    }
    section#head {
      display: flex;
      position: relative;
      flex-direction: row;
      flex-shrink: 0;
      align-items: center;
      line-height: 2em;
      border-bottom-style: solid;
      border-bottom-width: thin;
      border-color: inherit;
      cursor: pointer;
    }
    section#tr {
      position: relative;
      display: inline-block;
      border: thin solid transparent;
    }
    section#tr.null {
      background: none; color: inherit;
    }
    section#tr.null:nth-child(even) {
      background-color: rgba(137, 137, 137, 0.15);
    }
    section#tr.true {
      background: #D91B1B; color: var(--bright-text-color);
    }
    section#tr.false {
      background: #920bad; color: var(--bright-text-color);
    }
    section#tr.undefined {
      background: #c3ab12; color: inherit;
    }
    section#body {
      display: flex;
      flex-direction: column;
      width: 100%;
      position: relative;
      flex: 1;
      overflow-x: auto;
      overflow-y: scroll;
    }
    section#body.reverse {
      flex-direction: column-reverse;
    }
    section#td {
      font-size: 1em;
      position: relative;
      padding: 0em 0.75em;
      white-space: nowrap;
    }
    section#td.x {
      min-width: 3.5em;
      float: left;
      clear: none;
    }
  </style>

    <section id='table'>
      <section id='caption'>[[caption]]</section>
      <section id='head' hidden$='[[hideHeader]]' on-tap='switchOrder'>
        <section id='td' class='x'>Datum</section>
        <section id='td' class='y'>Wert <span hidden$="[[!unit]]" style="font-style:italic;">([[unit]])</span></section>
      </section>
      <section id='body'>
      </section>
    </section>
  </template>

  <script>

    TableElement = Polymer({
      is: 'table-element',

      behaviors: [ElementBehavior],

      properties: {
        caption: {
          type: String,
          value: ''
        },
        unit: {
          type: String,
          value: 'Wert'
        },
        descendingOrder: {
          type: Boolean,
          value: false,
          observer: 'setOrder'
        },
        highlightExceeding: {
          type: Boolean,
          value: false
        },
        hideHeader: {
          type: Boolean,
          value: false
        },
        showFullDate: {
          type: Boolean,
          value: false
        },
        hideOverflow: {
          type: Boolean,
          value: false
        },
        updateEveryValue: {
          type: Boolean,
          value: true,
          readOnly: true
        },
        _body: {
          type: Object,
          value: function() {
            return Polymer.dom(this.$.body);
          }
        },
        _map: {
          type: Object,
          value: function() {
            return {};
          }
        }
      },

      attached: function() {
        this._body = this.$.body;
        if (this.hideOverflow) {
          this._body.style.overflow = 'hidden';
        }
      },

      _updateView: function(value, splices) {
        var row, tdX, tdY, isExceeding, index, tdI;
        if (value === undefined) {
          if (splices !== undefined)
            splices.values.forEach(function(v){
              if (this._map[v.x] && this._map[v.x].nodeType === 1)
                this._body.removeChild(this._map[v.x]);
              this._map[v.x] = null;
            }, this)
          else {
            while (this._body.children[0])
                this._body.removeChild(this._body.children[0]);
          }
          for (var i = 0; i < this.values.length; i++) {
            this.createRow(this.values[i]);
          }
        }
        else {
          this.createRow(value)
        }
      },

      createRow: function(value) {
        row = document.createElement('section');
        row.id = 'tr';
        tdX = document.createElement('section');
        tdX.id = 'td'; tdX.classList.add('x','style-scope','table-element');
        tdX.textContent = (this.showFullDate ? new Date(value.x).toLocaleString() : new Date(value.x).toLocaleTimeString());
        tdY = document.createElement('section');
        tdY.id = 'td'; tdY.classList.add('y','style-scope','table-element');
        isExceeding = (value.exceeds === null) ? false : true;
        tdY.textContent = (this.isBoolean ? (isExceeding ? '✗' : '✓') : value.y);

        if (this.highlightExceeding === true)
          row.className = value.exceeds;
        row.classList.add('style-scope', 'table-element');

        row.appendChild(tdX); row.appendChild(tdY);
        if (this._map[value.x])
          this._body.removeChild(this._map[value.x]);
        this._map[value.x] = null;
        this._map[value.x] = row;

        this._body.insertBefore(row, this._body.childNodes[0]);
      },

      switchOrder: function() {
        if (this.descendingOrder === true) {
          this.$.body.classList.remove('reverse');
          this.descendingOrder = false;
        }
        else {
          this.$.body.classList.add('reverse');
          this.descendingOrder = true;
        }
      },
      setOrder: function(order) {
        if (order === false) {
          this.$.body.classList.remove('reverse');
        }
        else {
          this.$.body.classList.add('reverse');
        }
      }
    });

  </script>

</dom-module>
