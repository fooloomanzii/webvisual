<link rel='import' href='../behaviors/element-behavior.html'>
<dom-module id='table-element'>
	<template>
  <style>
    :host {
      /*height needs to be set by outer element*/
      color: var(--primary-text-color);
      display: flex;
      height: inherit;
      text-align: center;
      font-size: 0.75em;
      line-height: 1.5em;
      overflow: hidden;
      cursor: default;
      z-index: auto;
      background: white;
      border-radius: inherit;
      border-color: #BBBBBB;
    }
    :host[dark] {
      background: #a8a8a8;
      border-color: #808080;
    }
    section#table {
      display: inline-flex;;
			flex-direction: column;
      position: relative;
      border-color: inherit;
    }
    section#caption {
      display: block;
      position: relative;
      font-size: 0.9em;
      font-weight: bold;
      padding: 0em 1.5em;
    }
    section#body {
      display: inline-block;;
			float: left;
			clear: both;
      position: relative;
      overflow-x: hidden;
      overflow-y: scroll;
    }
		section.tr {
			position: relative;
			display: inline-flex;
	    flex-shrink: 0;
			float: left;
			clear: both;
			width: 100%;
		}
		section.tr, section.tr.inrange {
			background: none; color: inherit;
		}
		section.tr.inrange:nth-child(even) {
			background-color: rgba(137, 137, 137, 0.15);
		}
		section.tr.exceeds {
			background: var(--element-state-exceeds-color);
			color: var(--element-state-exceeds-text-color);
		}
		section.tr.deceeds {
			background: var(--element-state-deceeds-color);
			color: var(--element-state-deceeds-text-color);
		}
		section.tr.undefined {
			background: var(--element-state-undefined-color);
			color: var(--element-state-undefined-text-color);
		}
    section#body.reverse {
      flex-direction: column-reverse;
    }
		section.tr > section {
      font-size: 1em;
      position: relative;
      padding: 0em 0.75em;
      white-space: nowrap;
    }
    section.tr > section:first-child {
      min-width: 3.5em;
    }
		section#head.tr {
			line-height: 2em;
			border-bottom-style: solid;
			border-bottom-width: thin;
			border-color: inherit;
			cursor: pointer;
		}
  </style>

    <section id='table'>
      <section id='caption'>[[caption]]</section>
      <section id='head' class='tr' hidden$='[[hideHeader]]' on-tap='switchOrder'>
        <section>Datum</section>
        <section>Wert <span hidden$="[[!unit]]" style="font-style:italic;">([[unit]])</span></section>
      </section>
      <section id='body'>
      </section>
    </section>
  </template>

	<script>
		TableElement = Polymer({
			is: 'table-element',

			behaviors: [ElementBehavior],

			properties: {
				caption: {
					type: String,
					value: ''
				},
				unit: {
					type: String,
					value: 'Wert'
				},
				descendingOrder: {
					type: Boolean,
					value: false,
					observer: 'setOrder'
				},
				highlightExceeding: {
					type: Boolean,
					value: false
				},
				hideHeader: {
					type: Boolean,
					value: false
				},
				showFullDate: {
					type: Boolean,
					value: false
				},
				hideOverflow: {
					type: Boolean,
					value: false
				},
				updateEveryValue: {
					type: Boolean,
					value: true,
					readOnly: true
				},
				_body: {
					type: Object,
					value: function() {
						return Polymer.dom(this.$.body);
					}
				},
				_map: {
					type: Object,
					value: function() {
						return {};
					}
				}
			},

			attached: function() {
				this._body = this.$.body;
				if (this.hideOverflow) {
					this._body.style.overflow = 'hidden';
				}
			},

			render: function(value, splices) {
				if (value === undefined) {
					if (Array.isArray(splices))
						splices.forEach(function(v) {
							if (this._map[v.x] && this._map[v.x].nodeType === 1)
								this._body.removeChild(this._map[v.x]);
							this._map[v.x] = null;
							delete this._map[v.x];
						}, this)
					else {
						while (this._body.children[0])
							this._body.removeChild(this._body.children[0]);
						this._map = {};
					}
					// if (this.values) {
					// 	for (var i = this.values.length - 1; i >= 0; i--) {
					// 		this.createRow(this.values[i]);
					// 	}
					// 	Array.prototype.sort.call(this._body.childNodes, this.compareFn);
					// }
				} else {
					for (var i = 0; i < value.length; i++) {
						this.createRow(value[i]);
					}
				}
			},

			createRow: function(value) {
				if (this._map && this._map[value.x]) {
					return;
				}
				var row, tdX, tdY, isExceeding, status;

				row = document.createElement('section');
				row.classList.add('tr', 'style-scope', 'table-element');

				tdX = document.createElement('section');
				tdX.classList.add('style-scope', 'table-element');
				tdX.textContent = (this.showFullDate ? new Date(value.x).toLocaleString() : new Date(value.x).toLocaleTimeString());

				tdY = document.createElement('section');
				tdY.classList.add('style-scope', 'table-element');
				isExceeding = (value.state === 0) ? false : true;
				tdY.textContent = (this.isBoolean ? (isExceeding ? '✗' : '✓') : value.y);

				if (this.highlightExceeding === true) {
					switch (value.state) {
						case 0: status = 'inrange'; break;
						case -1: status = 'deceeds'; break;
						case 1: status = 'exceeds'; break;
						default: status = 'undefined';
					}
					row.classList.add(status);
				}

				row.appendChild(tdX);
				row.appendChild(tdY);
				row.x = value.x;

				this._map[value.x] = row;

				this._body.insertBefore(row, this._body.children[0]);
			},

			compareFn: function(a, b) {
				if (a.x > b.x) return 1;
				if (a.x < b.x) return -1;
				return 0;
			},

			switchOrder: function() {
				if (this.descendingOrder === true) {
					this.$.body.classList.remove('reverse');
					this.descendingOrder = false;
				} else {
					this.$.body.classList.add('reverse');
					this.descendingOrder = true;
				}
			},
			setOrder: function(order) {
				if (order === false) {
					this.$.body.classList.remove('reverse');
				} else {
					this.$.body.classList.add('reverse');
				}
			}
		});
	</script>

</dom-module>
