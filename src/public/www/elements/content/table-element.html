<link rel='import' href='../behaviors/element-behavior.html'>
<dom-module id='table-element'>
	<template>
  <style>
    :host {
      /*height needs to be set by outer element*/
      color: var(--primary-text-color);
      display: flex;
      height: auto;
			width: auto;
      text-align: center;
      font-size: 0.75em;
      line-height: 1.5em;
			flex-shrink: 2 !important;
      cursor: default;
      z-index: auto;
      background: white;
      border-radius: inherit;
      border-color: #BBBBBB;
    }
    :host[dark] {
      background: #a8a8a8;
      border-color: #808080;
    }
    #table {
      display: inline-flex;
			width: 100%;
			height: auto;
			flex-direction: column;
      position: relative;
      border-color: inherit;
    }
    #caption {
      display: block;
      position: relative;
      font-size: 0.9em;
      font-weight: bold;
      padding: 0em 1.5em;
    }
    #body {
			display: inline-flex;
			flex-direction: column;
			width: auto;
			height: auto;
      position: relative;
      overflow-x: hidden;
      overflow-y: scroll;
    }
		.block {
			display: none;
			position: relative;
		}
		.block:first-child {
			display: block;
		}
		.block:nth-child(2) {
			display: block;
		}
		.tr {
			position: relative;
			display: flex;
			float: left;
			clear: both;
			width: 100%;
		}
		.tr, .tr.inrange {
			background: none; color: inherit;
		}
		.tr.inrange:nth-child(even) {
			background: rgba(137, 137, 137, 0.15);
		}
		.tr.exceeds {
			background: var(--element-state-exceeds-color);
			color: var(--element-state-exceeds-text-color);
		}
		.tr.deceeds {
			background: var(--element-state-deceeds-color);
			color: var(--element-state-deceeds-text-color);
		}
		.tr.undefined {
			background: var(--element-state-undefined-color);
			color: var(--element-state-undefined-text-color);
		}
    #body.reverse {
      flex-direction: column-reverse;
    }
		.tr > span {
      font-size: 1em;
      position: relative;
      padding: 0em 0.75em;
      white-space: nowrap;
    }
    .tr > :first-child {
      min-width: 3.5em;
    }
		#head.tr {
			display: block;
			line-height: 2em;
			border-bottom-style: solid;
			border-bottom-width: thin;
			border-color: inherit;
			cursor: pointer;
		}
  </style>

    <section id='table'>
      <section id='caption'>[[caption]]</section>
      <section id='head' class='tr' hidden$='[[hideHeader]]' on-tap='switchOrder'>
        <span>Datum</span>
        <span>Wert <span hidden$="[[!unit]]" style="font-style:italic;">([[unit]])</span></span>
      </section>
      <section id='body' on-scroll='scrollHandler'>
				<section class='block'></section>
      </section>
    </section>
  </template>

	<script>
		TableElement = Polymer({
			is: 'table-element',

			behaviors: [ElementBehavior],

			properties: {
				caption: {
					type: String,
					value: ''
				},
				unit: {
					type: String,
					value: 'Wert'
				},
				descendingOrder: {
					type: Boolean,
					value: false,
					observer: 'setOrder'
				},
				highlightExceeding: {
					type: Boolean,
					value: false
				},
				hideHeader: {
					type: Boolean,
					value: false
				},
				showFullDate: {
					type: Boolean,
					value: false
				},
				hideOverflow: {
					type: Boolean,
					value: false
				},
				updateEveryValue: {
					type: Boolean,
					value: true,
					readOnly: true
				},

				maxProBlock: {
					type: Number,
					value: 60
				}
			},

			_map: Object,
			_body: Object,

			attached: function() {
				this._body = this.$.body;
				if (this.hideOverflow) {
					this._body.style.overflow = 'hidden';
				}
			},

			render: function(value, splices) {
				if (value === undefined) {
					if (Array.isArray(splices))
						splices.forEach(function(v) {
							if (this._map[v.x] && this._map[v.x].nodeType === 1)
								this._map[v.x].parentNode.removeChild(this._map[v.x]);
							this._map[v.x] = null;
							delete this._map[v.x];
						}, this)
					else {
						while (this._body.children[0])
							this._body.removeChild(this._body.children[0]);
						this._map = {};
					}
				} else {
					for (var i = 0; i < value.length; i++) {
						this.createRow(value[i]);
					}
				}
			},

			createRow: function(value) {
				if (this._map && this._map[value.x]) {
					return;
				}
				var row, tdX, tdY, isExceeding, status;

				row = document.createElement('section');
				tdX = document.createElement('span');
				tdX.className = 'style-scope table-element';
				tdX.innerText = (this.showFullDate ? new Date(value.x).toLocaleString() : new Date(value.x).toLocaleTimeString());

				tdY = document.createElement('span');
				tdY.className = 'style-scope table-element';
				isExceeding = (value.state === 0) ? false : true;
				tdY.innerText = (this.isBoolean ? (isExceeding ? '✗' : '✓') : value.y);

				if (this.highlightExceeding === true) {
					switch (value.state) {
						case 0: status = 'inrange'; break;
						case -1: status = 'deceeds'; break;
						case 1: status = 'exceeds'; break;
						default: status = 'undefined';
					}
					row.className = status + " tr style-scope table-element";
				} else {
					row.className = "tr style-scope table-element";
				}

				row.appendChild(tdX);
				row.appendChild(tdY);
				// row.x = value.x;

				this._map[value.x] = row;

				if (this._body.children[0].children.length > this.maxProBlock) {
					var block = document.createElement('section');
					block.className = 'block style-scope table-element';
					block.appendChild(row);
					this._body.insertBefore(block, this._body.children[0]);
				}
				else
					this._body.children[0].insertBefore(row, this._body.children[0].children[0]);
			},

			scrollHandler: function(e) {
				// console.log(e.target.offsetHeight, e.target.scrollTop, e.target.scrollHeight);
				if (3 * e.target.offsetHeight + e.target.scrollTop > e.target.scrollHeight) {
          for (var i = 0; i < this._body.children.length; i++) {
						if (this._body.children[i].style.display !== 'block') {
							this._body.children[i].style.display = 'block';
							return;
						}
					}
        }
			},

			compareFn: function(a, b) {
				if (a.x > b.x) return 1;
				if (a.x < b.x) return -1;
				return 0;
			},

			switchOrder: function() {
				if (this.descendingOrder === true) {
					this.$.body.classList.remove('reverse');
					this.descendingOrder = false;
				} else {
					this.$.body.classList.add('reverse');
					this.descendingOrder = true;
				}
			},
			setOrder: function(order) {
				if (order === false) {
					this.$.body.classList.remove('reverse');
				} else {
					this.$.body.classList.add('reverse');
				}
			}
		});
	</script>

</dom-module>
