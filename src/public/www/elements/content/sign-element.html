<dom-module id='sign-element'>
  <style>
    :host {
      position: relative;
      box-sizing: border-box;
      flex-direction: column;
      display: inline-flex;
      outline: none;
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
      -webkit-touch-callout: none; -webkit-tap-highlight-color: rgba(0,0,0,0);
      background: transparent;
      font-size: 1em;
      line-height: 1;
      align-self: stretch;
      border-radius: 2px 2px 2px 3px;
      border: thin solid rgba(0,0,0,.15);
      transition: box-shadow 0.28s cubic-bezier(0.4, 0, 0.2, 1);
    }
    :host:focus {
      border-color: rgba(0,0,0,.25);
    }
		:host[checked] {
			border-color: rgba(52, 84, 117, 0.4);
		}
    section#sign {
      height: auto;
      width: 100%;
      background: var(--element-color);
      color: var(--element-text-color);
      border-top-left-radius: inherit; border-top-right-radius: inherit; border-bottom-left-radius: 0; border-bottom-right-radius: 0;
      cursor: pointer;
      box-shadow: inherit;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 4em;
      min-width: 5em;
      padding-bottom: 0.25em;
      box-sizing: border-box;
      border-color: rgba(0,0,0,.12);
      border-right-width: 0;
      border-right-style: solid;
      border-bottom-width: thin;
      border-bottom-style: solid;
    }
    :host[dark] section#sign{
      color: #d3d3d3;
    }
    section#sign.inrange {
      background: var(--element-inrange-color);
      color: var(--element-state-inrange-text-color);
    }
    section#sign.exceeds {
      background: var(--element-state-exceeds-color);
      color: var(--element-state-exceeds-text-color);
    }
    section#sign.deceeds {
      background: var(--element-state-deceeds-color);
      color: var(--element-state-deceeds-text-color);
    }
    section#sign.undefined {
      background: var(--element-state-undefined-color);
      color: var(--element-state-undefined-text-color);
    }
    section#actualValueSection {
      display: flex;
      flex: 1;
      background: linear-gradient(180deg,rgba(255,255,255,0),rgba(230,230,230,0.2),rgba(255,255,255,0));
      padding: 0.25em;
      line-height: 1.5em;
      justify-content: center;
      align-items: center;
      border-radius: inherit;
    }
    section#valueSection {
      font-size: 1em;
      padding: 0 0.25em;
      float: left;
    }
    section#unitSection {
      margin-left: 0.25em;
      font-size: 0.8em;
      float: right;
    }
    section#dateSection {
      font-size: 0.6em;
      text-align: center;
      position: absolute;
      left: 0; right: 0; bottom: 0;
      padding: 0.5em;
      pointer-events: none;
    }
    section#caption {
      height: auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      cursor: default;
      box-sizing: border-box;
      position: relative;
      border-top-left-radius: 0; border-top-right-radius: 0; border-bottom-left-radius: inherit; border-bottom-right-radius: inherit;
      background: white;
      color: var(--primary-text-color);
      line-height: 1.5;
      padding: 0.25em 0.75em 0.5em 0.5em;
      flex: 1 0 auto;
      margin: 0;
      border: none;
    }
    :host[dark] section#caption {
      background: #B0B0B0;
      color: #1d1d1d;
    }
    section#caption span#captions {
      padding: 0;
      margin: 0;
      font-weight: normal;
      font-size: 0.6em;
    }
    span#captions:first-child {
      font-weight: bold !important;
      font-size: 1em !important;
    }
    span#captions:nth-child(2) {
      font-size: 0.85em !important;
    }
    span#captions:nth-child(3) {
      font-size: 0.75em !important;
    }
    svg#exceeding {
      height: 1.5em;
      width: 1.5em;
      fill: currentColor;
    }
    paper-ripple#ripple {
      color: #1d1d1d;
    }
    @media all and (max-width: 480px) {
      section#sign {
        min-width: 4em;
      }
    }
    @media all and (min-width: 600px) {
      :host[horizontal] {
        flex-direction: row;
      }
      :host[horizontal] section#sign {
        border-top-left-radius: inherit; border-top-right-radius: 0; border-bottom-left-radius: inherit; border-bottom-right-radius: 0;
        border-bottom-width: 0;
        border-right-width: thin;
        height: 100%;
        width: auto;
      }
      :host[horizontal] section#caption {
        border-top-left-radius: 0; border-top-right-radius: inherit; border-bottom-left-radius: 0; border-bottom-right-radius: inherit;
        height: 100%;
        width: auto;
      }
    }
    svg#bookmark {
      padding: 4px;
      cursor: pointer;
      outline: none;
      position: absolute;
      right: -5px;
      top: -5px;
      height: 1.25em;
      width: 1.25em;
      fill: #1f1f1f;
      stroke: rgba(255, 255, 255, 0.25);;
      stroke-width: 0.5px;
      opacity: 0.75;
      transform-origin: center;
      transition: all 280ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    svg#bookmark:hover {
      transform: scale(1.4);
      opacity: 1;
    }
    section#tooltip {
      display: block;
      position: absolute;
      transition: all 280ms ease;
      opacity: 1;
      visibility: visible;
      background: rgba(77,77,77, 0.8);
      color: #f1f1f1;
      border-radius: 5px;
      z-index: 150;
      outline: none;
    }
    section#tooltip:not(.opened) {
      opacity: 0;
      visibility: hidden;
    }
    section#tooltip div.title {
      font-size: 0.5em;
      font-weight: normal;
      padding: 0.5em;
      text-align: center;
    }
    section#tooltip section#tooltipContent {
      display: inline-flex;
    }
    section#tooltip section#tooltipContent table-element:first-child {
      border-right: solid thin #BBB;
    }
    section#tooltip section#tooltipContent table-element {
      background: transparent;
      color: currentColor;
      min-width: 4em;
      max-height: calc(10vh + 6em);
    }
    [hidden] {
      pointer-events: none;
    }
  </style>
  <template>
      <section id='sign' class='inrange'>

        <section id='actualValueSection' on-tap='_select'>
          <paper-ripple hidden$='[[!selectable]]' id='ripple'></paper-ripple>
          <section hidden$='[[isBoolean]]'>
            <section id='valueSection'></section><section id='unitSection'>[[unit]]</section>
          </section>
          <section hidden$='[[!isBoolean]]'>
            <svg id='exceeding' hidden$='[[!isExceeding]]' viewBox='0 0 24 24'>
                <g id='error-outline'><path d='M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z'/></g>
            </svg>
          </section>
        </section>

        <section id='dateSection' hidden$='[[!showDate]]'>
        </section>

        <svg id='bookmark' hidden$='[[!_hasTooltip(hasExceeded)]]' viewBox='0 0 24 24' on-tap='_toggleTooltip' aria-label='Alarme'>
          <g id='announcement'><path d='M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z'/></g>
        </svg>
      </section>

      <section id='caption' hidden$='[[!showCaption]]'>
        <template id='captiontemplate' is='dom-repeat' items='[[captionKeys]]' as='captionKey'>
          <span id='captions' hidden$='[[isEmptyCaption(captionKey)]]'>[[getKey(captionKey, keys.*)]]</span>
        </template>
      </section>

      <section id='tooltip' hidden$='[[!_hasTooltip(hasExceeded)]]' on-tap='_hideTooltip' on-mouseleave='_hideTooltip' role='tooltip' tabindex='-1'>
        <div class='title'>Alarmphasen</div>
        <section id='tooltipContent'>
          <table-element id='firstStateChangeTable' caption='Start' hide-header no-socket-connection show-full-date hide-overflow is-boolean='[[isBoolean]]' id="[[id]]" label="[[label]]"></table-element>
          <table-element id='lastStateChangeTable' caption='Ende' hide-header no-socket-connection hide-overflow is-boolean='[[isBoolean]]' id="[[id]]" label="[[label]]"></table-element>
        </section>
      </section>

  </template>

  <script>

    SignElement = Polymer({
      is: 'sign-element',

      behaviors: [
        ElementBehavior
      ],

      properties: {
        showDate: {
          type: Boolean,
          value: false
        },
        horizontal: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        showCaption: {
          type: Boolean,
          value: true
        },
        tooltip: {
          type: Boolean,
          value: false
        },
        exeedable: {
          type: Boolean,
          value: true
        },
        updateEveryValue: {
          type: Boolean,
          value: false,
          readOnly: true
        }
      },

      hostAttributes: {
        tabindex: '0'
      },

      attached: function() {
        if (this.tooltip)
          this._setTooltip();
      },

      setExceedingStatus: function(isExceeding, state) {
        var status;
        this.set('isExceeding', isExceeding);
        switch (state) {
          case 0: status='inrange'; break;
          case -1: status='deceeds'; break;
          case 1: status='exceeds'; break;
          default: status='undefined';
        }
        this.$.sign.className = status + " style-scope sign-element";
      },

      render: function(value) {
        if (value === undefined)
          return;

        // set value
        if (!this.isBoolean)
          this.$.valueSection.textContent = value.y;

        // set date
        if (this.showDate)
          this.$.dateSection.textContent = new Date(value.x).toLocaleTimeString();
      },

      _setTooltip: function() {
        this.$.firstStateChangeTable.insertValues(this.firstStateChange);
        this.$.lastStateChangeTable.insertValues(this.lastStateChange);
      },

      _setFirstStateChange: function(value) {
        this.firstStateChange.push(value);
        this.$.firstStateChangeTable.createRow(value);
      },

      _setLastStateChange: function(value) {
        this.lastStateChange.push(value);
        this.$.lastStateChangeTable.createRow(value);
      },

      _handleChecked: function() {
        if (this.hasExceeded) this._hideTooltip();
      },

      _hasTooltip: function(hasExceeded) {
        return hasExceeded && this.tooltip;
      },

      _openTooltip: function() {
        if (!this.hasExceeded) return;
        this.$.tooltip.classList.add('opened');
        this._updateTooltipPosition();
      },

      _toggleTooltip: function() {
        // if (!this.hasExceeded) return;
        if (this.$.tooltip.classList.contains('opened'))
          this.$.tooltip.classList.remove('opened');
        else {
          this.$.tooltip.classList.add('opened');
          this._updateTooltipPosition();
        }
      },

      _hideTooltip: function() {
        this.$.tooltip.classList.remove('opened');
      },

      _updateTooltipPosition: function() {
        var offset = 8;

        var parentRect = this.getBoundingClientRect();
        var targetRect = this.$.sign.getBoundingClientRect();
        var thisRect = this.$.tooltip.getBoundingClientRect();

        var targetLeft = targetRect.left - parentRect.left;
        var targetTop = targetRect.top - parentRect.top;
        var tooltipLeft = targetLeft + targetRect.width + offset;
        var tooltipTop = targetTop + (targetRect.height - thisRect.height) / 2;

        if (tooltipLeft + thisRect.width + parentRect.left > window.innerWidth) {
          this.$.tooltip.style.right = '0px';
          this.$.tooltip.style.left = 'auto';
        } else {
          this.$.tooltip.style.left = Math.max(0, tooltipLeft) + 'px';
          this.$.tooltip.style.right = 'auto';
        }

        if (tooltipTop + thisRect.height + parentRect.top> window.innerHeight) {
          this.$.tooltip.style.top = '0px';
          this.$.tooltip.style.bottom = 'auto';
        } else {
          this.$.tooltip.style.top = Math.max(0, tooltipTop) + 'px';
          this.$.tooltip.style.bottom = 'auto';
        }
      }
    });
  </script>

</dom-module>
