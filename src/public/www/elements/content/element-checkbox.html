<dom-module id="element-checkbox">
  <template strip-whitespace>
    <style>
      :host {
        display: inline-block;
        position: relative;
        line-height: 0;
        --calculated-box-size: var(--box-size, 20px);
        padding: 0.25em 0.5em;
        transition: background-color 150ms ease;
      }

      :host[checked] {
        background-color: var(--box-checked-background, white);
      }

      :host(:focus) {
        outline: 1px var(--bright-primary-color);
      }

      .hidden {
        display: none;
      }
      section#container {
        display: inline-flex;
        white-space: nowrap;
        position: relative;
        cursor: pointer;
        @apply(--font-common-base);
        line-height: 0;
        -webkit-tap-highlight-color: transparent;
      }

      section#boxContainer {
        display: inline-block;
				align-self: center;
        position: relative;
        width: var(--calculated-box-size);
        height: var(--calculated-box-size);
        min-width: var(--calculated-box-size);
        margin: var(--box-margin, initial);
        vertical-align: var(--box-vertical-align, middle);
        background-color: var(--box-unchecked-background-color, transparent);
      }

      section#ripple {
        position: absolute;

        /* Center the ripple in the box by negative offsetting it by
         * (rippleWidth - rippleWidth) / 2 */
        top: calc(0px - (2.66 * var(--calculated-box-size) - var(--calculated-box-size)) / 2);
        left: calc(0px - (2.66 * var(--calculated-box-size) - var(--calculated-box-size)) / 2);
        width: calc(2.66 * var(--calculated-box-size));
        height: calc(2.66 * var(--calculated-box-size));
        color: var(--box-unchecked-ripple-color, --bright-text-color);
        opacity: 0.25;
        pointer-events: none;
      }

      section#box {
        position: relative;
        box-sizing: border-box;
        position: relative;
        height: 100%;
        border: solid var(--box-border, 2px);
        border-radius: 2px;
        background: rgba(255, 255, 255, 0.9);
        pointer-events: none;
        -webkit-transition: background-color 150ms, border-color 150ms, opacity 150ms;
        transition: background-color 150ms, border-color 150ms, opacity 150ms;
      }

      /* box checked animations */
      section#box.checked section#arrow {
        -webkit-animation: arrow-expand 150ms ease-out forwards;
        animation: arrow-expand 150ms ease-out forwards;
      }

      @-webkit-keyframes arrow-expand {
        0% {
          -webkit-transform: scale(0, 0) rotate(45deg);
        }
        100% {
          -webkit-transform: scale(1, 1) rotate(45deg);
        }
      }

      @keyframes arrow-expand {
        0% {
          transform: scale(0, 0) rotate(45deg);
        }
        100% {
          transform: scale(1, 1) rotate(45deg);
        }
      }

      section#arrow {
        position: absolute;
        width: 36%;
        height: 70%;
        border-style: solid;
        border-top: none;
        border-left: none;
        border-right-width: calc(2/15 * var(--calculated-box-size));
        border-bottom-width: calc(2/15 * var(--calculated-box-size));
        border-color: var(--box-arrow-color, white);
        -webkit-transform-origin: 97% 86%;
        transform-origin: 97% 86%;
        box-sizing: content-box; /* protect against page-level box-sizing */
      }

      /* label */
      section.caption {
        position: relative;
        display: flex;
        flex-direction: row;
        padding-left: 0.25em;
        white-space: normal;
        color: currentColor;
      }
      section.caption > span.captions {
        padding: 0;
        font-weight: normal;
				line-height: 1.4;
        width: 100%;
        font-size: 0.5em;
      }

      :host:not([horizontal]) section.caption {
        flex-direction: column;
      }

      section.caption > span.captions.prefered {
        font-size: 0.8em;
      }
      :host([checked]) section.caption > span.captions.prefered {
        font-weight: bold;
      }

      section#container.inrange section#box {
        background-color: var(--element-color);
        opacity: 0.25;
      }
      section#container.exceeds section#box {
        border-color: var(--element-state-exceeds-color);
        background-color: var(--element-state-exceeds-color);
      }
      section#container.deceeds section#box {
        border-color: var(--element-state-deceeds-color);
        background-color: var(--element-state-deceeds-color);
      }
      section#container.undefined section#box {
        border-color: var(--element-state-undefined-color);
        background-color: var(--element-state-undefined-color);
      }

      section#container section#box.checked {
        opacity: 1;
      }

      section#container.inrange, section#ripple {
        color: var(---primary-text-color);
      }
      section#container.exceeds, section#ripple {
        color: var(--element-state-exceeds-color);
      }
      section#container.deceeds, section#ripple {
        color: var(--element-state-deceeds-color);
      }
      section#container.undefined, section#ripple {
        color: var(--element-state-undefined-color);
      }
      /* disabled state */

      :host([disabled]) section#box {
        opacity: 0.5;
        border-color: var(--box-unchecked-color, --primary-text-color);
      }
      :host([disabled][checked]) section#box {
        background-color: var(--disabled-text-color, --primary-text-color);
        opacity: 0.5;
      }
      :host([disabled]) section#caption  {
        opacity: 0.65;
      }
      /* invalid state */
      section#box.invalid:not(.checked) {
        border-color: var(--form-invalid);
      }
      section#sign {
        cursor: pointer;
        box-shadow: inherit;
        position: relative;
        display: flex;
        flex-direction: column;
        min-height: 3em;
        min-width: 3em;
        padding-bottom: 0.75em;
        box-sizing: border-box;
      }
      section#actualValueSection {
        display: flex;
        flex: 1;
        background: linear-gradient(180deg,rgba(255,255,255,0),rgba(230,230,230,0.2),rgba(255,255,255,0));
        padding: 0.25em;
        line-height: 1.5em;
        justify-content: center;
        align-items: center;
      }
      section#valueSection {
        font-size: 1em;
        float: left;
      }
      section#unitSection {
        margin-left: 0.25em;
        font-size: 0.8em;
        float: right;
      }
      section#dateSection {
        font-size: 0.6em;
        text-align: center;
        position: absolute;
        left: 0; right: 0; bottom: 0.25em;
        padding: 0.5em;
        pointer-events: none;
      }
      dropdown-element#value {
        --dropdown-background: rgba(0, 0, 0, 0.5);
        --dropdown-text-color: var(--bright-text-color);
        border-radius: 2px;
      }
      dropdown-element#caption {
        --dropdown-background: white;
        --dropdown-text-color: var(--primary-text-color);
        --dropdown-shadow: none;
        font-size: 1em;
      }
      iron-icon {
        --icon-height: var(--calculated-box-size);
        --icon-width: var(--calculated-box-size);
      }
			/*section#extra {
				visibility: hidden;
				background-color: rgba(0, 0, 0, 0.2);
				width: 0.5em;
				height: 100%;
				position: absolute;
				right: 0;
				top: 0;
				border-top-right-radius: inherit;
				border-bottom-right-radius: inherit;
			}
			:host([checked]):hover section#extra {
				visibility: visible;
			}*/
    </style>

    <section id="container" class="inrange" on-click='_select'>
      <section id="boxContainer">
        <section id="box" class$="[[_computeBoxClass(checked)]]">
          <section id="arrow" class$="[[_computeArrowClass(checked)]]"></section>
        </section>
        <section id="ripple">
          <paper-ripple></paper-ripple>
        </section>
      </section>

      <section id="preferedKey" class="caption">
        <span class="captions prefered">[[getPreferedKey(preferedKey, keys.*)]]</span>
        <template is="dom-if" if="[[!captionDropdown]]">
          <template id='captiontemplate' is='dom-repeat' items='[[reducedCaptionKeys]]' as='captionKey'>
            <span class='captions' hidden$='[[isEmptyCaption(captionKey, preferedKey)]]'>[[getKey(captionKey, reducedCaptionKeys.*)]]</span>
          </template>
        </template>
      </section>
    </section>

    <template is="dom-if" if="[[captionDropdown]]">
      <dropdown-element id="caption" for="preferedKey" target-showing-event="mouseover" target-hiding-event="mouseleave" position="bottom" align="start">
        <section class="caption">
          <template id='captiontemplate' is='dom-repeat' items='[[reducedCaptionKeys]]' as='captionKey'>
            <span class='captions' hidden$='[[isEmptyCaption(captionKey)]]'>[[getKey(captionKey, keys.*)]]</span>
          </template>
        </section>
      </dropdown-element>
    </template>

    <dropdown-element id="value" for="boxContainer" shadow target-showing-event="mouseover" target-hiding-event="mouseleave" position="bottom" align="end" offset="4">
      <section id='sign'>
        <section id='actualValueSection'>
          <section hidden$='[[isBoolean]]' style="display: inline-flex;">
            <section id='valueSection'></section>
            <section id='unitSection'>[[unit]]</section>
          </section>
          <section hidden$='[[!isBoolean]]'>
            <iron-icon icon='error-outline' hidden$='[[!isExceeding]]'></iron-icon>
            <iron-icon icon='check' hidden$='[[isExceeding]]'></iron-icon>
          </section>
        </section>
        <section id='dateSection' hidden$='[[!showDate]]'></section>
      </section>
    </dropdown-element>

    <!-- <dropdown-element id="table" for="extra" target-showing-event="mouseover" target-hiding-event="mouseleave" position="right" align="start" offset="4">
      <table-element id='[[id]]' label='[[label]]'></table-element>
    </dropdown-element> -->
  </template>

  <script>
    ElementCheckbox = Polymer({
      is: 'element-checkbox',

      behaviors: [
        ElementBehavior
      ],

      properties: {
        showDate: {
          type: Boolean,
          value: false
        },
        horizontal: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },
        captionDropdown: {
          type: Boolean,
          value: false
        },
        selectable: {
          type: Boolean,
          value: false
        },
        preferedKey: {
          type: String,
          value: ""
        },
				reducedCaptionKeys: {
					type: Array,
					value: function() {
            return [];
          }
				},
        updateEveryValue: {
          type: Boolean,
          value: false,
          readOnly: true
        },

        draggable: {
          type: Boolean,
          value: true
        },
        droppable: {
          type: Boolean,
          value: true
        }
      },

      getPreferedKey: function(preferedKey) {
				this.set('reducedCaptionKeys', this.captionKeys.filter(function(key) {return (key !== preferedKey)} ));
        return this.keys[this.preferedKey] || this.keys[this.reducedCaptionKeys[0]];
      },

      isEmptyCaption: function(key) {
        if (!this.keys[key]) return true;
        else return false;
      },

      setExceedingStatus: function(isExceeding, state) {
        var status;
        this.set('isExceeding', isExceeding);
        // set color of the sign
        switch (state) {
          case 0 : status = 'inrange'; break;
          case -1: status = 'deceeds'; break;
          case 1 : status = 'exceeds'; break;
          default: status = 'undefined';
        }
        this.$.container.className = status + " style-scope element-checkbox";
      },

      render: function(value) {
        if (value === undefined)
          return;

        // set value
        if (!this.isBoolean === true)
          this.$.valueSection.textContent = value.y;

        // set date
        if (this.showDate === true)
          this.$.dateSection.textContent = new Date(value.x).toLocaleTimeString();
      },

      _computeBoxClass: function(checked, invalid) {
        var className = '';
        if (checked) {
          className += 'checked ';
        }
        if (invalid) {
          className += 'invalid';
        }
        return className;
      },

      _computeArrowClass: function(checked) {
        return checked ? '' : 'hidden';
      }
    });
  </script>
</dom-module>
